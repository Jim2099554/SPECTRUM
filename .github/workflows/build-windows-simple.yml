name: Build SENTINELA Windows (Simple)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        
    - name: Install Python deps (minimal)
      run: |
        python -m pip install --upgrade pip wheel setuptools
        pip install fastapi==0.104.1 uvicorn==0.24.0 sqlalchemy==2.0.23
        pip install passlib[bcrypt]==1.7.4 python-jose[cryptography]==3.3.0
        pip install PyPDF2==3.0.1 pandas==2.1.3 numpy==1.26.2
        pip install python-dotenv==1.0.0 requests==2.31.0
        pip install pyinstaller==6.2.0
      shell: cmd
      
    - name: Build Frontend
      working-directory: frontend
      run: |
        npm install
        npm run build
      shell: cmd
      
    - name: Copy Frontend
      run: |
        if exist backend\client rmdir /s /q backend\client
        xcopy /E /I /Y frontend\dist backend\client
      shell: cmd
      
    - name: Create dirs
      run: |
        if not exist backend\audios mkdir backend\audios
        if not exist backend\photos mkdir backend\photos
        if not exist backend\transcripts mkdir backend\transcripts
      shell: cmd
      
    - name: Build with PyInstaller
      run: pyinstaller sentinela.spec --clean --noconfirm
      shell: cmd
      continue-on-error: true
      
    - name: Check build
      run: |
        if exist dist\SENTINELA_Backend\SENTINELA_Backend.exe (
          echo Build SUCCESS
          dir dist\SENTINELA_Backend
        ) else (
          echo Build FAILED
          exit 1
        )
      shell: cmd
      
    - name: Upload artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: SENTINELA-Windows-Simple
        path: dist/SENTINELA_Backend/
        retention-days: 30
